local ChestTeleportSystem = {}

-- Lưu trữ tất cả các Chest đã tìm thấy
local chestLocations = {}

-- Hàm quét để tìm tất cả các Chest
function ChestTeleportSystem.scanForChests()
    local workspace = game:GetService("Workspace")
    local mapsFolder = workspace:WaitForChild("Maps")
    
    -- Xóa danh sách cũ trước khi quét mới
    table.clear(chestLocations)
    
    -- Quét qua tất cả các Map
    for _, mapModel in ipairs(mapsFolder:GetChildren()) do
        local chestsFolder = mapModel:FindFirstChild("Chests")
        if chestsFolder then
            for _, chest in ipairs(chestsFolder:GetChildren()) do
                if chest:IsA("Model") or chest:IsA("BasePart") then
                    local chestPosition = chest:IsA("Model") and 
                        chest:GetPrimaryPartCFrame().Position or 
                        chest.Position
                    
                    table.insert(chestLocations, {
                        name = chest.Name,
                        mapName = mapModel.Name,
                        instance = chest,
                        position = chestPosition
                    })
                    print(string.format("Đã tìm thấy: %s trong map %s", chest.Name, mapModel.Name))
                end
            end
        end
    end
    
    print(string.format("Tổng số Chest đã tìm thấy: %d", #chestLocations))
    return chestLocations
end

-- Hàm teleport đến chest
function ChestTeleportSystem.teleportToChest(player, chestName, mapName)
    if not player or not player.Character then
        warn("Không tìm thấy nhân vật của người chơi!")
        return false
    end
    
    local humanoidRootPart = player.Character:FindFirstChild("HumanoidRootPart")
    if not humanoidRootPart then
        warn("Không tìm thấy HumanoidRootPart!")
        return false
    end
    
    -- Tìm chest phù hợp
    for _, chestInfo in ipairs(chestLocations) do
        if chestInfo.name == chestName and chestInfo.mapName == mapName then
            -- Tạo offset để không teleport chính xác vào chest
            local offset = Vector3.new(0, 5, 0)
            local targetPosition = chestInfo.position + offset
            
            -- Thực hiện teleport
            humanoidRootPart.CFrame = CFrame.new(targetPosition)
            print(string.format("Đã teleport đến %s trong map %s", chestName, mapName))
            return true
        end
    end
    
    warn(string.format("Không tìm thấy chest '%s' trong map '%s'!", chestName, mapName))
    return false
end

-- Hàm lấy danh sách tất cả các chest
function ChestTeleportSystem.getChestList()
    local chestList = {}
    for _, chestInfo in ipairs(chestLocations) do
        table.insert(chestList, {
            name = chestInfo.name,
            mapName = chestInfo.mapName
        })
    end
    return chestList
end

-- Hàm hiển thị danh sách chest trong Output
function ChestTeleportSystem.printChestList()
    print("=== DANH SÁCH TẤT CẢ CHEST ===")
    for _, chest in ipairs(chestLocations) do
        print(string.format("- %s (Map: %s)", chest.name, chest.mapName))
    end
    print("=============================")
end

-- Hàm tìm chest gần nhất với người chơi
function ChestTeleportSystem.teleportToNearestChest(player)
    if not player or not player.Character then return false end
    
    local humanoidRootPart = player.Character:FindFirstChild("HumanoidRootPart")
    if not humanoidRootPart then return false end
    
    local playerPos = humanoidRootPart.Position
    local nearestChest = nil
    local shortestDistance = math.huge
    
    for _, chestInfo in ipairs(chestLocations) do
        local distance = (chestInfo.position - playerPos).Magnitude
        if distance < shortestDistance then
            shortestDistance = distance
            nearestChest = chestInfo
        end
    end
    
    if nearestChest then
        return ChestTeleportSystem.teleportToChest(player, nearestChest.name, nearestChest.mapName)
    end
    
    return false
end

-- Khởi tạo hệ thống khi script được load
ChestTeleportSystem.scanForChests()

-- Tự động cập nhật danh sách chest mỗi 30 giây
spawn(function()
    while wait(30) do
        ChestTeleportSystem.scanForChests()
    end
end)

return ChestTeleportSystem
